<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการเซิร์ฟเวอร์ - Admin</title>
    <link rel="stylesheet" href="/css/admin.css">
</head>

<body>
    <div class="admin-container">
        <nav class="admin-sidebar">
            <div class="admin-logo">Admin Panel</div>
            <div class="admin-nav">
                <a href="/admin/dashboard" class="admin-nav-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    <span>แดชบอร์ด</span>
                </a>
                <a href="/admin/users" class="admin-nav-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>จัดการผู้ใช้</span>
                </a>
                <a href="/admin/servers" class="admin-nav-item active">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                        <line x1="8" y1="21" x2="16" y2="21"></line>
                        <line x1="12" y1="17" x2="12" y2="21"></line>
                    </svg>
                    <span>จัดการเซิร์ฟเวอร์</span>
                </a>
                <a href="/admin/channels" class="admin-nav-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="4" y1="9" x2="20" y2="9"></line>
                        <line x1="4" y1="15" x2="20" y2="15"></line>
                        <line x1="10" y1="3" x2="8" y2="21"></line>
                        <line x1="16" y1="3" x2="14" y2="21"></line>
                    </svg>
                    <span>จัดการช่อง</span>
                </a>
                <a href="/admin/messages" class="admin-nav-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>จัดการข้อความ</span>
                </a>
            </div>
            <div class="admin-nav-footer">
                <a href="/" class="admin-nav-item" target="_blank">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    <span>ไปที่แชท</span>
                </a>
                <button id="adminLogoutBtn" class="admin-nav-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span>ออกจากระบบ</span>
                </button>
            </div>
        </nav>

        <main class="admin-main">
            <header class="admin-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>จัดการเซิร์ฟเวอร์</h1>
                    <button class="admin-btn admin-btn-primary" onclick="openCreateServerModal()">+
                        เพิ่มเซิร์ฟเวอร์</button>
                </div>
            </header>

            <div class="admin-content">
                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ชื่อ</th>
                                <th>การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% servers.forEach(server=> { %>
                                <tr>
                                    <td>
                                        <%= server.id %>
                                    </td>
                                    <td>
                                        <%= server.name %>
                                    </td>
                                    <td>
                                        <button class="admin-btn admin-btn-warning"
                                            onclick="openEditServerModal(<%= server.id %>, '<%= server.name %>', '<%= server.avatar || '' %>')">แก้ไข</button>
                                        <button class="admin-btn admin-btn-danger"
                                            onclick="deleteServer(<%= server.id %>)">ลบ</button>
                                    </td>
                                </tr>
                                <% }); %>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="serverModal" class="admin-modal">
        <div class="admin-modal-content">
            <div class="admin-modal-header">
                <h2 class="admin-modal-title" id="serverModalTitle">เพิ่มเซิร์ฟเวอร์</h2>
                <button class="admin-modal-close" onclick="closeServerModal()">×</button>
            </div>
            <form id="serverForm" onsubmit="handleServerSubmit(event)" enctype="multipart/form-data">
                <input type="hidden" id="serverId" />
                <div class="admin-form-group">
                    <label class="admin-form-label">ชื่อเซิร์ฟเวอร์</label>
                    <input type="text" id="serverName" class="admin-form-input" required />
                </div>
                <div class="admin-form-group">
                    <label class="admin-form-label">ภาพเซิร์ฟเวอร์ (URL หรืออัพโหลดไฟล์)</label>
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                        <img id="serverAvatarPreview" src="https://placehold.co/100/5865F2/white?text=?" alt="Preview"
                            style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover; border: 2px solid #2B2D31;" />
                        <div style="flex: 1;">
                            <input type="text" id="serverAvatarUrl" placeholder="https://example.com/image.png"
                                class="admin-form-input" style="margin-bottom: 8px;"
                                onchange="previewServerAvatarUrl(event)" />
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: #949BA4; font-size: 12px;">หรือ</span>
                                <input type="file" id="serverAvatar" accept="image/*" class="admin-form-input"
                                    style="padding: 8px; flex: 1;" onchange="previewServerAvatar(event)" />
                            </div>
                            <button type="button" class="admin-btn" onclick="clearServerAvatar()"
                                style="margin-top: 8px; background: #35373C; color: #F2F3F5; padding: 6px 12px; font-size: 12px;">ลบภาพ</button>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="admin-btn" onclick="closeServerModal()"
                        style="background: #35373C; color: #F2F3F5;">ยกเลิก</button>
                    <button type="submit" class="admin-btn admin-btn-primary">บันทึก</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/admin.js"></script>
    <script>
        function openCreateServerModal() {
            document.getElementById('serverModalTitle').textContent = 'เพิ่มเซิร์ฟเวอร์';
            document.getElementById('serverId').value = '';
            document.getElementById('serverName').value = '';
            document.getElementById('serverAvatar').value = '';
            document.getElementById('serverAvatarUrl').value = '';
            document.getElementById('serverAvatarPreview').src = 'https://placehold.co/100/5865F2/white?text=?';
            document.getElementById('serverModal').classList.add('active');
        }

        function openEditServerModal(id, name, avatar) {
            document.getElementById('serverModalTitle').textContent = 'แก้ไขเซิร์ฟเวอร์';
            document.getElementById('serverId').value = id;
            document.getElementById('serverName').value = name;
            document.getElementById('serverAvatar').value = '';
            document.getElementById('serverAvatarUrl').value = avatar || '';
            document.getElementById('serverAvatarPreview').src = avatar || 'https://placehold.co/100/5865F2/white?text=' + (name ? name.charAt(0) : '?');
            document.getElementById('serverModal').classList.add('active');
        }

        function previewServerAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('serverAvatarPreview').src = e.target.result;
                    document.getElementById('serverAvatarUrl').value = '';
                };
                reader.readAsDataURL(file);
            }
        }

        function previewServerAvatarUrl(event) {
            const url = event.target.value.trim();
            if (url) {
                document.getElementById('serverAvatarPreview').src = url;
                document.getElementById('serverAvatar').value = '';
            } else {
                const name = document.getElementById('serverName').value;
                document.getElementById('serverAvatarPreview').src = 'https://placehold.co/100/5865F2/white?text=' + (name ? name.charAt(0) : '?');
            }
        }

        function clearServerAvatar() {
            document.getElementById('serverAvatar').value = '';
            document.getElementById('serverAvatarUrl').value = '';
            const name = document.getElementById('serverName').value;
            document.getElementById('serverAvatarPreview').src = 'https://placehold.co/100/5865F2/white?text=' + (name ? name.charAt(0) : '?');
        }

        function closeServerModal() {
            document.getElementById('serverModal').classList.remove('active');
        }

        function handleServerSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('serverId').value;
            const name = document.getElementById('serverName').value;
            const avatarUrl = document.getElementById('serverAvatarUrl').value.trim();
            const avatarFile = document.getElementById('serverAvatar').files[0];

            const formData = new FormData();
            if (id) {
                formData.append('serverId', id);
            }
            formData.append('name', name);
            if (avatarUrl) {
                formData.append('avatarUrl', avatarUrl);
            }
            if (avatarFile) {
                formData.append('avatar', avatarFile);
            }

            const url = id ? '/admin/servers/update' : '/admin/servers/create';

            fetch(url, {
                method: 'POST',
                body: formData
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showNotification(id ? 'แก้ไขสำเร็จ' : 'สร้างสำเร็จ', 'success');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        showNotification(data.error || 'เกิดข้อผิดพลาด', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('เกิดข้อผิดพลาด', 'error');
                });
        }

        async function deleteServer(serverId) {
            const confirmed = await showConfirmModal({
                title: 'ยืนยันการลบ',
                message: 'คุณต้องการลบเซิร์ฟเวอร์นี้หรือไม่? (จะลบช่องทั้งหมดในเซิร์ฟเวอร์นี้ด้วย)',
                confirmText: 'ลบ',
                cancelText: 'ยกเลิก',
                danger: true
            });
            if (!confirmed) return;
            fetch('/admin/servers/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ serverId })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showNotification('ลบสำเร็จ', 'success');
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        showNotification(data.error || 'เกิดข้อผิดพลาด', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('เกิดข้อผิดพลาด', 'error');
                });
        }
    </script>
</body>

</html>